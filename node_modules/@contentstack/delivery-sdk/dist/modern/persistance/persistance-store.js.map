{"version":3,"sources":["../../../src/persistance/persistance-store.ts"],"sourcesContent":["import { Store, PersistanceStoreConfig } from './config/persistance-storage-config';\nimport { localStorage } from './storages/local-storage';\nimport { memoryStorage } from './storages/memory-storage';\nimport { Storage } from './types/storage';\nimport { StorageType } from './types/storage-type';\nimport { ErrorMessages } from '../lib/error-messages';\n\n/**\n * Persistence store for caching data with expiration support\n * Supports localStorage, memoryStorage, and custom storage implementations\n */\nexport class PersistanceStore {\n  protected store: Storage = localStorage;\n  readonly config: PersistanceStoreConfig;\n  protected name: string;\n\n  /**\n   * Creates a new PersistanceStore instance\n   * @param {PersistanceStoreConfig} [config] - Configuration options for the store\n   */\n  constructor(config?: PersistanceStoreConfig) {\n    let defaultConfig: PersistanceStoreConfig = {\n      storeType: 'localStorage',\n      maxAge: 1000 * 60 * 60 * 24,\n      serializer: JSON.stringify,\n      deserializer: JSON.parse,\n    };\n    defaultConfig = {\n      ...defaultConfig,\n      ...config,\n    };\n    this.setStore(defaultConfig.storeType, (defaultConfig as unknown as Store).storage);\n    this.config = defaultConfig;\n    this.name = ''; // TODO add stack api key to name\n  }\n  private setStore(type?: StorageType | 'customStorage', store?: Storage) {\n    switch (type) {\n      case 'localStorage':\n        break;\n      case 'memoryStorage':\n        this.store = memoryStorage;\n        break;\n      case 'customStorage':\n        if (!store) {\n          throw new TypeError(ErrorMessages.MISSING_CUSTOM_STORAGE);\n        } else {\n          this.store = store;\n        }\n        break;\n    }\n  }\n  /**\n   * Sets an item in the store with optional expiration\n   * @param {string} key - The key to store the value under\n   * @param {any} value - The value to store\n   * @param {string} [contentTypeUid] - Optional content type UID for key scoping\n   * @param {number} [maxAge] - Optional maximum age in milliseconds (overrides config maxAge)\n   */\n  setItem(key: string, value: any, contentTypeUid?: string, maxAge?: number) {\n    if (!key) {\n      return;\n    }\n    const generatedKey = this.generateCSKey(key, contentTypeUid);\n\n    if (!value) {\n      this.store.removeItem(generatedKey);\n\n      return;\n    }\n    const expiry = this.calculateExpiry(maxAge);\n    let content: any = { value, expiry };\n    if (this.config.serializer) {\n      content = this.config.serializer(content);\n    }\n\n    this.store.setItem(generatedKey, content);\n  }\n  /**\n   * Gets an item from the store if it exists and hasn't expired\n   * @param {string} key - The key to retrieve\n   * @param {string} [contentTypeUid] - Optional content type UID for key scoping\n   * @returns {any} The stored value if found and not expired, undefined otherwise\n   */\n  getItem(key: string, contentTypeUid?: string): any {\n    const generatedKey = this.generateCSKey(key, contentTypeUid);\n    const content = this.store.getItem(generatedKey);\n\n    if (content) {\n      if (this.config.deserializer) {\n        const item = this.config.deserializer(content);\n        if (!this.isExpire(item.expiry)) {\n          return item.value;\n        } else {\n          this.removeItem(key, contentTypeUid);\n        }\n      }\n    }\n  }\n\n  /**\n   * Removes an item from the store\n   * @param {string} key - The key to remove\n   * @param {string} [contentTypeUid] - Optional content type UID for key scoping\n   */\n  removeItem(key: string, contentTypeUid?: string) {\n    const generatedKey = this.generateCSKey(key, contentTypeUid);\n    this.store.removeItem(generatedKey);\n  }\n\n  /**\n   * Clears all items from the store, or items matching a specific content type UID\n   * @param {string} [contentTypeUid] - Optional content type UID to clear only matching items\n   */\n  clear(contentTypeUid?: string) {\n    if (!contentTypeUid) {\n      this.store.clear();\n    } else {\n      this.store.each((_, key) => {\n        if (key.match(contentTypeUid)) {\n          this.store.removeItem(key);\n        }\n      });\n    }\n  }\n\n  private generateCSKey(key: string, contentTypeUid?: string): string {\n    let keyPrefix = 'cs_store_js';\n    if (contentTypeUid) {\n      keyPrefix = contentTypeUid + '_' + keyPrefix;\n    }\n    keyPrefix = this.name + '_' + keyPrefix + '_' + key;\n\n    return keyPrefix;\n  }\n  private calculateExpiry(maxAge?: number): number {\n    const now = new Date();\n    const nowMSec = now.getTime();\n    if (maxAge) {\n      return nowMSec + maxAge;\n    } else if (this.config.maxAge) {\n      return nowMSec + this.config.maxAge;\n    }\n\n    return 0;\n  }\n\n  private isExpire(dateTime: number): boolean {\n    if (dateTime) {\n      return dateTime < new Date().getTime();\n    }\n\n    return true;\n  }\n}\n"],"mappings":"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","names":[]}