{"version":3,"sources":["../../../src/lib/cache.ts"],"sourcesContent":["// import { PersistanceStore } from '../persistance';\n\nimport { PersistanceStore } from '../persistance';\nimport { CacheOptions, Policy } from './types';\n\n/**\n * Extracts entry UID from request URL if available\n * @param config - Request config object\n * @returns entry UID if found, null otherwise\n */\nfunction extractEntryUidFromUrl(config: any): string | null {\n  if (!config.url) return null;\n  \n  // Match patterns like: /content_types/{content_type_uid}/entries/{entry_uid}\n  const entryUrlPattern = /\\/content_types\\/[^\\/]+\\/entries\\/([^\\/\\?]+)/;\n  const match = config.url.match(entryUrlPattern);\n  \n  return match ? match[1] : null;\n}\n\n/**\n * Generates an improved cache key using content type UID and entry UID\n * @param originalKey - Original cache key (apiKey)\n * @param contentTypeUid - Content type UID\n * @param entryUid - Entry UID (optional)\n * @returns Enhanced cache key\n */\nfunction generateEnhancedCacheKey(originalKey: string, contentTypeUid?: string, entryUid?: string): string {\n  let cacheKey = originalKey;\n  \n  if (contentTypeUid) {\n    cacheKey = `${contentTypeUid}_${cacheKey}`;\n  }\n  \n  if (entryUid) {\n    cacheKey = `${cacheKey}_entry_${entryUid}`;\n  }\n  \n  return cacheKey;\n}\n\n/**\n * Handles cache requests based on the cache policy\n * @param {CacheOptions} cacheOptions - Cache configuration options\n * @param {string} apiKey - API key for cache key generation\n * @param {Function} defaultAdapter - Default axios adapter function\n * @param {Function} resolve - Promise resolve function\n * @param {Function} reject - Promise reject function\n * @param {object} config - Request configuration object\n * @returns {Promise} Resolves or rejects based on cache policy and API response\n */\nexport async function handleRequest(\n  cacheOptions: CacheOptions,\n  apiKey: string,\n  defaultAdapter: any,\n  resolve: any,\n  reject: any,\n  config: any\n) {\n  const cacheStore = new PersistanceStore(cacheOptions);\n  \n  // Extract entry UID from URL or config\n  const entryUid = config.entryUid || extractEntryUidFromUrl(config);\n  \n  // Generate enhanced cache key using content type UID and entry UID\n  const enhancedCacheKey = generateEnhancedCacheKey(apiKey, config.contentTypeUid, entryUid);\n  \n  switch (cacheOptions.policy) {\n    case Policy.NETWORK_ELSE_CACHE: {\n      const apiResponse = await defaultAdapter(config);\n\n      if (apiResponse.data) {\n        cacheStore.setItem(enhancedCacheKey, JSON.parse(apiResponse.data), config.contentTypeUid, cacheOptions.maxAge);\n\n        return resolve({data: JSON.parse(apiResponse.data)});\n      } else {\n        const cacheResponse = cacheStore.getItem(enhancedCacheKey, config.contentTypeUid);\n        if (cacheResponse)\n          return resolve({\n            data: cacheResponse,\n            status: 200,\n            statusText: 'OK',\n            headers: {},\n            config: {},\n          });\n      }\n\n      return reject(apiResponse);\n    }\n    case Policy.CACHE_THEN_NETWORK: {\n      const cacheResponse = cacheStore.getItem(enhancedCacheKey, config.contentTypeUid);\n      if (cacheResponse)\n        return resolve({\n          data: cacheResponse,\n          status: 200,\n          statusText: 'OK',\n          headers: {},\n          config: {},\n        });\n\n      const apiResponse = await defaultAdapter(config);\n\n      if (apiResponse.data) {\n        cacheStore.setItem(enhancedCacheKey, JSON.parse(apiResponse.data), config.contentTypeUid, cacheOptions.maxAge);\n\n        return resolve({data: JSON.parse(apiResponse.data)});\n      } else {\n        return reject(apiResponse);\n      }\n    }\n    case Policy.CACHE_ELSE_NETWORK: {\n      const cacheResponse = cacheStore.getItem(enhancedCacheKey, config.contentTypeUid);\n\n      if (cacheResponse)\n        return resolve({\n          data: cacheResponse,\n          status: 200,\n          statusText: 'OK',\n          headers: {},\n          config: {},\n        });\n      else {\n        const apiResponse = await defaultAdapter(config);\n\n        if (apiResponse.data) {\n          cacheStore.setItem(enhancedCacheKey, JSON.parse(apiResponse.data), config.contentTypeUid, cacheOptions.maxAge);\n\n          return resolve({data: JSON.parse(apiResponse.data)});\n        } else {\n          return reject(apiResponse);\n        }\n      }\n    }\n  }\n}"],"mappings":";AAEA,SAAS,wBAAwB;AACjC,SAAuB,cAAc;AAOrC,SAAS,uBAAuB,QAA4B;AAC1D,MAAI,CAAC,OAAO,IAAK,QAAO;AAGxB,QAAM,kBAAkB;AACxB,QAAM,QAAQ,OAAO,IAAI,MAAM,eAAe;AAE9C,SAAO,QAAQ,MAAM,CAAC,IAAI;AAC5B;AASA,SAAS,yBAAyB,aAAqB,gBAAyB,UAA2B;AACzG,MAAI,WAAW;AAEf,MAAI,gBAAgB;AAClB,eAAW,GAAG,cAAc,IAAI,QAAQ;AAAA,EAC1C;AAEA,MAAI,UAAU;AACZ,eAAW,GAAG,QAAQ,UAAU,QAAQ;AAAA,EAC1C;AAEA,SAAO;AACT;AAYA,eAAsB,cACpB,cACA,QACA,gBACA,SACA,QACA,QACA;AACA,QAAM,aAAa,IAAI,iBAAiB,YAAY;AAGpD,QAAM,WAAW,OAAO,YAAY,uBAAuB,MAAM;AAGjE,QAAM,mBAAmB,yBAAyB,QAAQ,OAAO,gBAAgB,QAAQ;AAEzF,UAAQ,aAAa,QAAQ;AAAA,IAC3B,KAAK,OAAO,oBAAoB;AAC9B,YAAM,cAAc,MAAM,eAAe,MAAM;AAE/C,UAAI,YAAY,MAAM;AACpB,mBAAW,QAAQ,kBAAkB,KAAK,MAAM,YAAY,IAAI,GAAG,OAAO,gBAAgB,aAAa,MAAM;AAE7G,eAAO,QAAQ,EAAC,MAAM,KAAK,MAAM,YAAY,IAAI,EAAC,CAAC;AAAA,MACrD,OAAO;AACL,cAAM,gBAAgB,WAAW,QAAQ,kBAAkB,OAAO,cAAc;AAChF,YAAI;AACF,iBAAO,QAAQ;AAAA,YACb,MAAM;AAAA,YACN,QAAQ;AAAA,YACR,YAAY;AAAA,YACZ,SAAS,CAAC;AAAA,YACV,QAAQ,CAAC;AAAA,UACX,CAAC;AAAA,MACL;AAEA,aAAO,OAAO,WAAW;AAAA,IAC3B;AAAA,IACA,KAAK,OAAO,oBAAoB;AAC9B,YAAM,gBAAgB,WAAW,QAAQ,kBAAkB,OAAO,cAAc;AAChF,UAAI;AACF,eAAO,QAAQ;AAAA,UACb,MAAM;AAAA,UACN,QAAQ;AAAA,UACR,YAAY;AAAA,UACZ,SAAS,CAAC;AAAA,UACV,QAAQ,CAAC;AAAA,QACX,CAAC;AAEH,YAAM,cAAc,MAAM,eAAe,MAAM;AAE/C,UAAI,YAAY,MAAM;AACpB,mBAAW,QAAQ,kBAAkB,KAAK,MAAM,YAAY,IAAI,GAAG,OAAO,gBAAgB,aAAa,MAAM;AAE7G,eAAO,QAAQ,EAAC,MAAM,KAAK,MAAM,YAAY,IAAI,EAAC,CAAC;AAAA,MACrD,OAAO;AACL,eAAO,OAAO,WAAW;AAAA,MAC3B;AAAA,IACF;AAAA,IACA,KAAK,OAAO,oBAAoB;AAC9B,YAAM,gBAAgB,WAAW,QAAQ,kBAAkB,OAAO,cAAc;AAEhF,UAAI;AACF,eAAO,QAAQ;AAAA,UACb,MAAM;AAAA,UACN,QAAQ;AAAA,UACR,YAAY;AAAA,UACZ,SAAS,CAAC;AAAA,UACV,QAAQ,CAAC;AAAA,QACX,CAAC;AAAA,WACE;AACH,cAAM,cAAc,MAAM,eAAe,MAAM;AAE/C,YAAI,YAAY,MAAM;AACpB,qBAAW,QAAQ,kBAAkB,KAAK,MAAM,YAAY,IAAI,GAAG,OAAO,gBAAgB,aAAa,MAAM;AAE7G,iBAAO,QAAQ,EAAC,MAAM,KAAK,MAAM,YAAY,IAAI,EAAC,CAAC;AAAA,QACrD,OAAO;AACL,iBAAO,OAAO,WAAW;AAAA,QAC3B;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;","names":[]}