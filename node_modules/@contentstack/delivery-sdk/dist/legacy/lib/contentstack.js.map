{"version":3,"sources":["../../../src/lib/contentstack.ts"],"sourcesContent":["import { httpClient, retryRequestHandler, retryResponseErrorHandler, retryResponseHandler } from '@contentstack/core';\nimport { AxiosRequestHeaders } from 'axios';\nimport { handleRequest } from './cache';\nimport { Stack as StackClass } from './stack';\nimport { Policy, StackConfig, ContentstackPlugin, Region } from './types';\nimport * as Utility from './utils';\nimport * as Utils from '@contentstack/utils';\nexport { Utils };\n\nlet version = '{{VERSION}}';\n\n/**\n * @method stack\n * @memberof Contentstack\n * @description Creates a stack instance\n * @param {StackConfig} config - config object for stack with apiKey, deliveryToken and environment as required fields\n * @returns {StackClass} Stack instance\n * @example\n * import contentstack from '@contentstack/delivery-sdk'\n * const stack = contentstack.stack({ apiKey: \"apiKey\", deliveryToken: \"deliveryToken\", environment: \"environment\" });\n * @example\n * import contentstack from '@contentstack/delivery-sdk'\n * const stack = contentstack.stack({\n *   apiKey: \"apiKey\",\n *   deliveryToken: \"deliveryToken\",\n *   environment: \"environment\",\n *   region:\"region\",\n *   locale:\"locale\",\n *   cacheOptions: {\n *    policy: Policy.CACHE_THEN_NETWORK,\n *    storeType: 'localStorage'\n *   }\n * });\n */\n// eslint-disable-next-line @typescript-eslint/naming-convention\nexport function stack(config: StackConfig): StackClass {\n  const DEFAULT_HOST = Utility.getHostforRegion(config.region || Region.US, config.host);\n\n  let defaultConfig = {\n    defaultHostname: DEFAULT_HOST,\n    headers: {} as AxiosRequestHeaders,\n    params: {} as any,\n    live_preview: {} as any,\n    port: config.port as number,\n    ...config\n  };\n\n  config.host = defaultConfig.defaultHostname;\n\n  if (config.apiKey) {\n    defaultConfig.headers.api_key = config.apiKey;\n  } else {\n    throw new Error('API key for Stack is required.');\n  }\n  if (config.deliveryToken) {\n    defaultConfig.headers.access_token = config.deliveryToken;\n  } else {\n    throw new Error('Delivery token for Stack is required.');\n  }\n  if (config.environment) {\n    defaultConfig.params.environment = config.environment;\n  } else {\n    throw new Error('Environment for Stack is required');\n  }\n\n  if (config.locale) {\n    defaultConfig.params.locale = config.locale;\n  }\n\n  if (config.live_preview) {\n    if (Utility.isBrowser()) {\n      const params = new URL(document.location.toString()).searchParams;\n      if (params.has('live_preview')) {\n          config.live_preview.live_preview = params.get('live_preview') || config.live_preview.live_preview;\n      }\n      if (params.has('release_id')) {\n          defaultConfig.headers['release_id'] = params.get('release_id');\n      }\n      if (params.has('preview_timestamp')) {\n          defaultConfig.headers['preview_timestamp'] = params.get('preview_timestamp');\n      }\n    }\n  }\n\n  if (config.branch) {\n    defaultConfig.headers.branch = config.branch;\n  }\n\n  if (config.early_access) {\n    defaultConfig.headers['x-header-ea'] = config.early_access.join(',');\n  }\n\n  defaultConfig.headers['X-User-Agent'] = 'contentstack-delivery-typescript/' + version;\n\n\n  const client = httpClient(defaultConfig as any);\n\n  if (config.logHandler) client.defaults.logHandler = config.logHandler;\n\n  if (config.cacheOptions && config.cacheOptions.policy !== Policy.IGNORE_CACHE) {\n    const defaultAdapter = client.defaults.adapter;\n    client.defaults.adapter = (adapterConfig: any) => {\n      return new Promise(async (resolve, reject) => {\n        if (config.cacheOptions)\n          await handleRequest(config.cacheOptions, config.apiKey, defaultAdapter, resolve, reject, adapterConfig);\n      });\n    };\n  }\n  // LogHandler interceptors\n  if (config.debug) {\n    // Request interceptor for logging\n    client.interceptors.request.use((requestConfig: any) => {\n      config.logHandler!('info', {\n        type: 'request',\n        method: requestConfig.method?.toUpperCase(),\n        url: requestConfig.url,\n        headers: requestConfig.headers,\n        params: requestConfig.params,\n        timestamp: new Date().toISOString()\n      });\n      return requestConfig;\n    });\n\n    // Response interceptor for logging\n    client.interceptors.response.use(\n      (response: any) => {\n        const level = getLogLevelFromStatus(response.status);\n        config.logHandler!(level, {\n          type: 'response',\n          status: response.status,\n          statusText: response.statusText,\n          url: response.config?.url,\n          method: response.config?.method?.toUpperCase(),\n          headers: response.headers,\n          data: response.data,\n          timestamp: new Date().toISOString()\n        });\n        return response;\n      },\n      (error: any) => {\n        const status = error.response?.status || 0;\n        const level = getLogLevelFromStatus(status);\n        config.logHandler!(level, {\n          type: 'response_error',\n          status: status,\n          statusText: error.response?.statusText || error.message,\n          url: error.config?.url,\n          method: error.config?.method?.toUpperCase(),\n          error: error.message,\n          timestamp: new Date().toISOString()\n        });\n        throw error;\n      }\n    );\n  }\n\n  // Helper function to determine log level based on HTTP status code\n  function getLogLevelFromStatus(status: number): string {\n    if (status >= 200 && status < 300) {\n      return 'info';\n    } else if (status >= 300 && status < 400) {\n      return 'warn';\n    } else if (status >= 400) {\n      return 'error';\n    } else {\n      return 'debug';\n    }\n  }\n\n  // Retry policy handlers\n  const errorHandler = (error: any) => {\n    return retryResponseErrorHandler(error, config, client);\n  };\n  client.interceptors.request.use(retryRequestHandler);\n  client.interceptors.response.use(retryResponseHandler, errorHandler);\n\n  if (config.plugins) {\n    client.interceptors.request.use((reqConfig: any): any => {\n      if (config && config.plugins)\n        config.plugins.forEach((pluginInstance: ContentstackPlugin) => {\n          reqConfig = pluginInstance.onRequest(reqConfig);\n        });\n      \n      return reqConfig;\n    });\n\n    client.interceptors.response.use((response: any) => {\n      if (config && config.plugins)\n        config.plugins.forEach((pluginInstance: ContentstackPlugin) => {\n          response = pluginInstance.onResponse(response.request, response, response.data);\n        });\n\n      return response;\n    });\n  }\n\n  return new StackClass(client, config);\n}\n"],"mappings":"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","names":[]}